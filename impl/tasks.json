[
  {
    "category": "test",
    "description": "Create test utilities package with fixtures, environment helpers, and assertions",
    "steps": [
      "Create internal/testutil/ directory",
      "Create fixtures.go with SampleRFC, SampleTasks, SampleState, SampleHistory test data",
      "Create env.go with SetupTestDir, LoadTestCredentials, MustMarshalJSON helpers",
      "Create assertions.go with AssertTasksEqual, AssertStateStatus custom assertions",
      "Add package documentation and build tags"
    ],
    "passes": true
  },
  {
    "category": "test",
    "description": "Move MockSpriteClient to shared location in sprite package",
    "steps": [
      "Extract MockSpriteClient from components_integration_test.go to internal/sprite/mock_client_test.go",
      "Add SetExistsResponse, SetReadFileResponse mock configuration methods",
      "Add GetWriteCalls verification method for write call tracking",
      "Update components_integration_test.go to use the shared mock",
      "Verify existing integration tests still pass"
    ],
    "passes": true
  },
  {
    "category": "test",
    "description": "Consolidate test setup helpers from real_sprites_integration_test.go into testutil",
    "steps": [
      "Move setupRealSpriteEnv to testutil/env.go",
      "Move findProjectRoot to testutil/env.go",
      "Move generateTestSpriteName to testutil/env.go with standard naming convention (wisp-test-{hash}-{timestamp})",
      "Move cleanupSprite to testutil/env.go",
      "Move waitForSpriteReady to testutil/env.go",
      "Update real_sprites_integration_test.go to use testutil helpers",
      "Run integration tests to verify no regressions"
    ],
    "passes": true
  },
  {
    "category": "refactor",
    "description": "Export setup functions from CLI package for testing",
    "steps": [
      "In start.go, export setupSprite as SetupSprite with proper documentation",
      "Export cloneRepo as CloneRepo",
      "Export createBranch as CreateBranch",
      "Export injectEnvVars as InjectEnvVars",
      "Export runCreateTasksPrompt as RunCreateTasksPrompt",
      "Update all internal callers to use new exported names",
      "Run unit tests to verify no regressions"
    ],
    "passes": true
  },
  {
    "category": "refactor",
    "description": "Add test-friendly Loop constructor with LoopOptions",
    "steps": [
      "Create LoopOptions struct with Client, SyncManager, Store, Config, Session, TUI, RepoPath, TemplateDir, StartTime fields",
      "Add NewLoopForTesting constructor that accepts LoopOptions",
      "Allow StartTime injection for deterministic time-based testing",
      "Update existing NewLoop to use LoopOptions internally",
      "Add unit tests for the new constructor"
    ],
    "passes": true
  },
  {
    "category": "refactor",
    "description": "Make Claude command building configurable via ClaudeConfig",
    "steps": [
      "Create ClaudeConfig struct with MaxTurns, MaxBudget, Verbose, OutputFormat fields",
      "Add DefaultClaudeConfig function returning production defaults (MaxTurns: 100, Verbose: true, etc.)",
      "Refactor Loop to accept ClaudeConfig as part of LoopOptions",
      "Update Claude command building to use ClaudeConfig values",
      "Add unit tests for ClaudeConfig and command building"
    ],
    "passes": true
  },
  {
    "category": "test",
    "description": "Add sprite cleanup registry for test resource tracking",
    "steps": [
      "Create internal/testutil/cleanup.go",
      "Add thread-safe createdSprites registry map",
      "Implement RegisterSprite function to track created sprites",
      "Implement CleanupAllSprites function to delete all registered sprites",
      "Add unit tests for the cleanup registry"
    ],
    "passes": true
  },
  {
    "category": "test",
    "description": "Add TestMain for global cleanup in integration tests",
    "steps": [
      "Create internal/integration/main_test.go with integration build tag",
      "Implement TestMain that runs tests and performs cleanup",
      "Add TrySetupRealSpriteEnv helper that returns nil if credentials unavailable",
      "Call CleanupAllSprites after all tests complete",
      "Log warnings for any cleanup failures"
    ],
    "passes": true
  },
  {
    "category": "test",
    "description": "Add test timeout safeguards to testutil",
    "steps": [
      "Add ContextWithTestDeadline helper that respects test deadline minus buffer",
      "Add ContextWithTimeout helper with sensible defaults for sprite operations",
      "Update all integration tests to use timeout helpers",
      "Add deadline-aware context creation in long-running tests",
      "Verify tests respect timeouts during CI runs"
    ],
    "passes": true
  },
  {
    "category": "test",
    "description": "Refactor TestRealSprite_SyncManagerIntegration to use production code paths",
    "steps": [
      "Update test to use testutil.SetupRealSpriteEnv",
      "Use testutil.GenerateTestSpriteName for sprite naming",
      "Register sprite with cleanup registry",
      "Use cli.SetupSprite instead of test-specific setup",
      "Use production SyncManager methods exactly as production code does",
      "Verify test still exercises the same scenarios"
    ],
    "passes": true
  },
  {
    "category": "test",
    "description": "Refactor TestRealSprite_SingleIterationWithClaude to use production Loop",
    "steps": [
      "Update test to use testutil helpers for setup",
      "Create Loop using NewLoopForTesting with production-like config",
      "Use ClaudeConfig with test-appropriate MaxTurns (1) and budget",
      "Run single iteration using Loop.Run with max 1 iteration",
      "Verify Claude command uses production args structure",
      "Update assertions to match production behavior"
    ],
    "passes": true
  },
  {
    "category": "test",
    "description": "Refactor TestRealSprite_FullLoopCompletion to use production code paths",
    "steps": [
      "Update test to use cli.SetupSprite for sprite setup",
      "Use production Loop with real Claude via NewLoopForTesting",
      "Use testutil helpers for environment and cleanup",
      "Verify production state sync works end-to-end",
      "Verify production history recording works",
      "Add assertions for all synced files (state.json, tasks.json, history.json)"
    ],
    "passes": true
  },
  {
    "category": "test",
    "description": "Add production path verification tests",
    "steps": [
      "Add TestRealSprite_LoopUsesProductionClaudeArgs to verify Claude command matches production",
      "Add TestRealSprite_SyncManagerSyncsAllFiles to verify all state files are synced",
      "Add test to verify production defaults are used when no overrides specified",
      "Add test to verify production error handling paths",
      "Tag tests with real_sprites and integration build tags"
    ],
    "passes": true
  },
  {
    "category": "feature",
    "description": "Add --headless flag to start command for E2E testing",
    "steps": [
      "Add startHeadless bool flag to start.go",
      "Register --headless flag in init function",
      "In runStart, check startHeadless flag",
      "If headless, run loop without TUI and print JSON results to stdout",
      "Add unit test for headless flag parsing",
      "Add integration test for headless execution"
    ],
    "passes": true
  },
  {
    "category": "test",
    "description": "Create CLI test harness for E2E tests",
    "steps": [
      "Create internal/integration/cli_harness_test.go with e2e build tag",
      "Implement CLIHarness struct with BinaryPath, WorkDir, testing.T fields",
      "Implement NewCLIHarness that builds wisp binary to temp directory",
      "Add Run method that executes wisp command and returns stdout, stderr, error",
      "Add RunWithTimeout method with configurable timeout",
      "Add helper to set environment variables for test runs"
    ],
    "passes": true
  },
  {
    "category": "test",
    "description": "Create test workspace setup for E2E tests",
    "steps": [
      "Add setupTestWorkspace function to cli_harness_test.go",
      "Create .wisp directory structure (templates, sessions subdirs)",
      "Copy config.yaml with test-appropriate settings",
      "Copy settings.json with test credentials",
      "Copy default templates from project",
      "Write .sprite.env with test credentials from environment"
    ],
    "passes": true
  },
  {
    "category": "test",
    "description": "Implement E2E test cases for CLI commands",
    "steps": [
      "Create internal/integration/cli_e2e_test.go with e2e build tag",
      "Add TestCLI_Init to verify init creates correct .wisp structure",
      "Add TestCLI_Status to verify status works with no sessions",
      "Add TestCLI_StartCreatesSprite to verify start creates sprite (uses --headless)",
      "Add TestCLI_StopAndResume to verify session stop and resume",
      "Add TestCLI_FullWorkflow to test complete start->iterate->done flow"
    ],
    "passes": true
  },
  {
    "category": "test",
    "description": "Add orphan sprite cleanup utility",
    "steps": [
      "Create cmd/cleanup-test-sprites/main.go",
      "Load sprite credentials from environment",
      "List all sprites matching pattern wisp-test-*",
      "Filter sprites older than configurable threshold (default 1 hour)",
      "Delete matching sprites with confirmation or --force flag",
      "Add to Makefile as 'make cleanup-test-sprites' target"
    ],
    "passes": true
  },
  {
    "category": "docs",
    "description": "Create test documentation",
    "steps": [
      "Create docs/testing.md with overview of test tiers",
      "Document how to run each test tier (unit, integration, real_sprites, e2e)",
      "Document required credentials and environment setup",
      "Document how to debug failed tests",
      "Document how to clean up orphaned sprites",
      "Add cross-references from README.md to testing.md"
    ],
    "passes": false
  },
  {
    "category": "setup",
    "description": "Add CI workflow for integration tests",
    "steps": [
      "Create .github/workflows/integration-tests.yml",
      "Add unit-tests job running on every push and PR",
      "Add component-tests job running integration tests with mocks"
    ],
    "passes": false
  }
]
